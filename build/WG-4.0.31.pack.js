/**
 * JavaScript application for SoHo web application container
 * $Id: soho.js
 */
/*global jQuery*/
var Soho=(function(){var f={wg_appName:"SoHo",wg_appVersion:"3.0",wg_url:"/",wg_lastUpdate:0,wg_serverTimeOffset:null,wg_updateDelay:30000,wg_sessionAge:0,wg_autolockDelay:0,wg_started:false};var d={wg_logged:false,wg_login:null,wg_name:null,wg_avatar:null,wg_pwdhash:null};let viewdata={available:{},loaded:{}};let uidata={lastAction:0,autolockThread:null,trayIcons:{},uiComponents:null};var c=function(){if(Soho.live){Soho.live.stop();Soho.live=null}};var b=function(){if(!Soho.live){Soho.live=new Soho.LiveService()}};var a=function(m){if(console.log){console.log("[start] Open user session...")}d.wg_logged=true;d.wg_login=m.sessiondata.userLogin;d.wg_name=m.sessiondata.userName;d.wg_avatar=m.sessiondata.userAvatar;d.wg_pwdhash=m.sessiondata.userPwdHash;f.wg_lastUpdate=m.sessiondata.serverTime;f.wg_sessionAge=m.sessiondata.sessionAge;f.wg_autolockDelay=m.settings.autolock*60000;f.wg_serverTimeOffset=(1*m.time.serverGMT);var k=document.createElement("link");k.type="text/css";k.rel="stylesheet";k.href=f.wg_url+"css.php?t="+new Date().getTime();var l=document.getElementsByTagName("link")[0];l.parentNode.insertBefore(k,l);if(console){console.log("[start] Load modules CSS stylesheet ("+f.wg_url+"css.php)")}if("localStorage" in window){if(window.localStorage.getItem("WG.nightmode")==="on"){document.body.setAttribute("nightmode","on")}}viewdata.available=m.views;Soho.ui.createMenu(m.menu);Soho.ui.createTrayIcons();Soho.ui.addTrayMenuItem("nightmode","Switch night mode...",Soho.ui.TrayMenuStack.TOP,function(){var n=jQuery("body#wg");if(n.hasAttr("nightmode")){n.removeAttr("nightmode");if("localStorage" in window){window.localStorage.setItem("WG.nightmode","off")}}else{n.attr("nightmode","on");if("localStorage" in window){window.localStorage.setItem("WG.nightmode","on")}}});Soho.ui.addTrayMenuItem("lock","Lock my session...",Soho.ui.TrayMenuStack.BOTTOM,function(){lock()});Soho.ui.addTrayMenuItem("logout","Log out...",Soho.ui.TrayMenuStack.BOTTOM,function(){logout()});Soho.View.applyStandardBehavior(uidata.uiComponents.main);if(f.wg_autolockDelay>0){uidata.autolockThread=setInterval(function(){if(new Date().getTime()-uidata.lastAction>f.wg_autolockDelay){lock()}},30000)}b();if("localStorage" in window&&window.localStorage.getItem("WG.defaultView")){Soho.setView(window.localStorage.getItem("WG.defaultView"))}else{Soho.setView("dashboard")}uidata.lastAction=new Date().getTime()};var g=function(){f={wg_lastUpdate:-1,wg_updateDelay:-1,wg_sessionAge:-1,wg_started:true};d={wg_logged:false,wg_login:null,wg_name:null,wg_avatar:null,wg_pwdhash:null};viewdata={available:{},loaded:{}};c();Soho.ui.removeAllTrayMenuItems();Soho.ui.destroyMenu();Soho.ui.removeAllTrayIcons();Soho.ui.removeCurrentView();Soho.ui.viewHistory={};if(uidata.autolockThread!==null){clearInterval(uidata.autolockThread);uidata.autolockThread=null}uidata.uiComponents.appName.setAttribute("class","");if("localStorage" in window){window.localStorage.removeItem("WG.lock");window.localStorage.removeItem("WG.defaultView")}};let logout=function(){if(!d.wg_logged){Soho.setStatus("You are not logged.",Soho.status.ALERT,"close");return}Soho.setStatus("Logout...",Soho.status.WAIT);var k=f.wg_url;g();Soho.ajax({url:k+"ws.php",data:{w:"auth",logout:"please"},success:function(){setTimeout("window.location.reload()",1600);Soho.setStatus("You are logged out.",Soho.status.SUCCESS)},error:function(m,n,l){setTimeout("window.location.reload()",10);if(n!="success"){Soho.setStatus("Unable to log out: "+n,Soho.status.FAILURE)}}})};let lock=function(){if(!d.wg_logged){return}if(uidata.uiComponents.locker.style.display=="block"){return}if(console){console.log("[ui] Lock")}uidata.uiComponents.locker.innerHTML="<h1>"+Soho.util.htmlspecialchars(f.wg_appName)+"</h1><p>This session is locked by <b>"+Soho.util.htmlspecialchars(d.wg_name)+"</b><br />Enter your password</p>";var k=document.createElement("input");k.setAttribute("type","password");k.onkeydown=function(){this.style.backgroundColor="#fff"};k.onblur=function(){this.focus()};var l=document.createElement("form");l.onsubmit=function(){if(Soho.security.sha1(d.wg_login+":"+k.value).substr(0,15)===d.wg_pwdhash){unlock()}else{k.value="";k.style.backgroundColor="#666"}return false};l.appendChild(k);uidata.uiComponents.locker.appendChild(l);uidata.uiComponents.locker.style.display="block";k.focus();if("localStorage" in window){window.localStorage.setItem("WG.lock",true)}};let unlock=function(){if(console){console.log("Unlock")}uidata.uiComponents.locker.style.display="none";if("localStorage" in window){window.localStorage.removeItem("WG.lock")}uidata.lastAction=new Date().getTime()};let welcome=function(n,k){if(console){console.log("[start] Ask for welcome message...")}Soho.setStatus("Get welcome message...",Soho.status.WAIT);var l=function(o,q,p){if(console){console.error("[start] Unable to get welcome message. This attempt has been logged.")}Soho.setStatus("Unable to reach welcome service: <em>"+p+"</em>",Soho.status.FAILURE,function(){Soho.setView("login",null,true)});if(k){k()}};var m=function(o){Soho.setStatus("Open session...",Soho.status.WAIT);a(o);Soho.setStatus(null);if(n){n()}};Soho.ajax({url:f.wg_url+"ws.php",data:{w:"welcome"},success:m,error:l})};var h=function(){if(f.wg_started){throw"Soho is allready started"}if(console){console.log("[start] Soho is starting, appURL is: "+f.wg_url)}Soho.trigger("beforeStart");document.body.setAttribute("id","wg");uidata.uiComponents=Soho.ui.createUIComponents();document.body.appendChild(uidata.uiComponents.container);Soho.ui.bindEvents();f.started=true;if(!d.wg_logged){if(console){console.log("[start] Start is finished. User is not logged: display login view.")}Soho.setView("login",null,true)}else{if(console){console.log("[start] Start is finished. User is allready logged: get welcome message.")}welcome()}};return{init:function(k){if(jQuery("body").attr("id")=="wg"||f.wg_started){throw"Soho is allready initialized"}if(console){console.log("[start] Initialization...")}if("appName" in k){document.title=f.wg_appName=k.appName}if("appVersion" in k){f.wg_appVersion=k.appVersion}if("appUrl" in k){f.wg_url=k.appUrl}if("lastUpdate" in k){f.wg_lastUpdate=parseInt(k.lastUpdate)}if("updateDelay" in k){f.wg_updateDelay=parseInt(k.updateDelay);if(console){console.warn("[deprecated] Usage of appdata.wg_updateDelay is deprecated")}}if("sessionAge" in k){f.wg_sessionAge=parseInt(k.sessionAge);if(console){console.warn("[deprecated] Usage of appdata.wg_sessionAge is deprecated")}}if("logged" in k){d.wg_logged=(k.logged===true)}jQuery("body .nojs").remove();h()},appName:function(){return f.wg_appName},appURL:function(){return f.wg_url},userName:function(){return d.wg_name},userAvatar:function(){return d.wg_avatar},lastUpdate:function(){return f.wg_lastUpdate},live:null,trim:jQuery.trim,isLogged:function(){return d.wg_logged},setView:function(l,n,k,m){Soho.ui.setView(l,n,k,m);return Soho},currentView:function(){return Soho.ui.currentView},ajax:function(n,m){var k=Soho.security.AES!=null;var l="dataType" in n?n.dataType:"json";var o={cache:(m===true),url:n.url,dataType:k?"text":l,type:"POST",success:function(q,s,p){if(Soho.security.AES!=null){q=Soho.security.aesDecrypt(q);if(l=="json"){try{q=JSON.parse(q)}catch(r){if("error" in n){n.error(p,s,"invalid JSON after decrypt")}return}}}if("success" in n){n.success(q,s,p)}},error:function(p,r,q){if("error" in n){n.error(p,r,q)}}};if("data" in n){if(k){for(let name in n.data){n.data[name]=jQuery.jCryption.encrypt(""+n.data[name],Soho.security.AES.password)}}o.data=n.data}if("context" in n){o.context=n.context}if(console){console.log("[ajax] POST "+n.url+" (AES="+(k?"on":"off")+", type="+l+", cache="+(m===true)+")")}return jQuery.ajax(o)},status:{WAIT:0,OK:1,SUCCESS:1,INFO:5,NOTICE:5,ALERT:10,WARNING:10,ERROR:20,FAILURE:20},setStatus:function(q,l,o,p){var n=uidata.uiComponents.status;if(!q){n.style.display="none";return this}n.style.display="block";var m="";switch(l){case Soho.status.WAIT:m="wait-msg";break;case Soho.status.SUCCESS:m="success-msg";break;case Soho.status.INFO:case Soho.status.NOTICE:m="info-msg";break;case Soho.status.ALERT:case Soho.status.WARNING:m="alert-msg";break;case Soho.status.ERROR:case Soho.status.FAILURE:m="failure-msg";break}n.setAttribute("class",m);n.innerHTML=q;if(o){if(o=="close"){p="close";o=function(){Soho.setStatus(null)}}else{if(!p){p="continue"}}var k=document.createElement("a");k.innerHTML=p;k.onclick=o;k.setAttribute("class","continue");k.setAttribute("href","javascript:;");n.appendChild(k);k.focus()}return Soho},time:{getLocalTime:function(){return new Date()},getServerOffset:function(){return f.wg_serverTimeOffset},getServerTime:function(){if(f.wg_serverTimezone===null){return new Date()}var m=new Date(),o=m.getTimezoneOffset(),l=f.wg_serverTimeOffset,n=(l/100*-1)*60,p=(o-n)*60000;var k=l<360?m.getTime()+p:m.getTime()-p;return new Date(k)}}}})();Soho.util={each:function(a,b){if(!a){return}if(a instanceof Object){for(let v in a){b(a[v],v)}}},createElement:function(d,a,c){var b=document.createElement(d);if(a){for(let attr in a){if(attr=="onclick"){b.onclick=a[attr]}else{b.setAttribute(attr,a[attr])}}}if(c){c.appendChild(b)}return b},implementListenerPattern:function(a){a.bind=function(c,d,b){if(!this.listeners){this.listeners=[]}this.listeners.push({e:c,c:d,o:b===true});return this};a.one=function(b,c){return this.bind(b,c,true)};a.unbind=function(b,c){if(!this.listeners){return false}if(b&&c){for(let i=0,j=this.listeners.length;i<j;i++){let li=this.listeners[i];if(!li){continue}if((li.e===b||b==="*")&&li.c===c){this.listeners.splice(i,1);return true}}}else{if(b){for(let i=0,j=this.listeners.length;i<j;i++){let li=this.listeners[i];if(!li){continue}if(li.e===b||b==="*"){this.listeners.splice(i,1);return true}}}else{this.listeners=[];return true}}return false};a.trigger=function(f,g){if(!this.listeners){return this}for(var d=0,c=this.listeners.length;d<c;d++){var b=this.listeners[d];if(!b){continue}if(b.e===f||b.e==="*"){this.eventDispath=b.c;this.eventDispath(g,this,f);if(b.o){this.listeners.splice(d,1)}}}this.eventDispath=null;return this}},htmlspecialchars:function(c,k,h,b){var f=0,d=0,g=false;if(typeof k==="undefined"||k===null){k=2}c=c.toString();if(b!==false){c=c.replace(/&/g,"&amp;")}c=c.replace(/</g,"&lt;").replace(/>/g,"&gt;");var a={ENT_NOQUOTES:0,ENT_HTML_QUOTE_SINGLE:1,ENT_HTML_QUOTE_DOUBLE:2,ENT_COMPAT:2,ENT_QUOTES:3,ENT_IGNORE:4};if(k===0){g=true}if(typeof k!=="number"){k=[].concat(k);for(d=0;d<k.length;d++){if(a[k[d]]===0){g=true}else{if(a[k[d]]){f=f|a[k[d]]}}}k=f}if(k&a.ENT_HTML_QUOTE_SINGLE){c=c.replace(/'/g,"&#039;")}if(!g){c=c.replace(/"/g,"&quot;")}return c},nl2br:function(c,b){var a=(b||typeof b==="undefined")?"<br />":"<br>";return(c+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+a+"$2")},str_replace:function(u,c,n,m){var h=0,g=0,q="",l="",d=0,p=0,k=[].concat(u),a=[].concat(c),t=n,b=Object.prototype.toString.call(a)==="[object Array]",o=Object.prototype.toString.call(t)==="[object Array]";t=[].concat(t);if(m){this.window[m]=0}for(h=0,d=t.length;h<d;h++){if(t[h]===""){continue}for(g=0,p=k.length;g<p;g++){q=t[h]+"";l=b?(a[g]!==undefined?a[g]:""):a[0];t[h]=(q).split(k[g]).join(l);if(m&&t[h]!==q){this.window[m]+=(q.length-t[h].length)/k[g].length}}}return o?t:t[0]},url2links:function(b){var a=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;return b.replace(a,"<a href='$1' target='_blank'>$1</a>")},asynchFileUpload:function(d,f,b){var a=new Date().getTime();var g="file-upload-asynch-"+a+"-"+Math.round(Math.random()*9999);var c=document.createElement("iframe");c.setAttribute("id",g);c.setAttribute("name",g);c.setAttribute("loaded","false");uidata.uiComponents.main.appendChild(c);c.onload=function(){if(this.getAttribute("loaded")!="true"){this.loaded="true";var h=c.contentDocument.getElementsByTagName("body")[0];c.loaded="true";var m=h.innerHTML,l=null;try{l=JSON.parse(h.innerHTML)}catch(k){l=null}jQuery(c).remove();if(l==null){b(m)}else{if("upload" in l&&l.upload=="OK"){f(l)}else{b(l)}}}};d.target=g;return true},parse_url:function(h,k){var l=["source","scheme","authority","userInfo","user","pass","host","port","relative","path","directory","file","query","fragment"],n=(this.php_js&&this.php_js.ini)||{},g=(n["phpjs.parse_url.mode"]&&n["phpjs.parse_url.mode"].local_value)||"php",b={php:/^(?:([^:\/?#]+):)?(?:\/\/()(?:(?:()(?:([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?()(?:(()(?:(?:[^?#\/]*\/)*)()(?:[^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/\/?)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/};var d=b[g].exec(h),c={},f=14;while(f--){if(d[f]){c[l[f]]=d[f]}}if(k){return c[k.replace("PHP_URL_","").toLowerCase()]}if(g!=="php"){var a=(n["phpjs.parse_url.queryKey"]&&n["phpjs.parse_url.queryKey"].local_value)||"queryKey";b=/(?:^|&)([^&=]*)=?([^&]*)/g;c[a]={};c[l[12]].replace(b,function(o,m,p){if(m){c[a][m]=p}})}delete c.source;return c}};Soho.util.implementListenerPattern(Soho);jQuery.fn.reverse=[].reverse;jQuery.fn.hasAttr=function(a){return this.attr(a)!==undefined};Soho.security={inOperation:false,login:function(b){var c=parseInt(b.getAttribute("expires"))*1000;if(c<=new Date().getTime()){b.style.display="none";var a=setTimeout(function(){Soho.setView("login",null,true)},3000);Soho.setStatus("Sorry, this form was expired. I will ask a new one...",Soho.status.WARNING,function(){clearTimeout(a);Soho.setView("login",null,true)},"Go on!");return false}Soho.security.vkb.div.style.display="none";if(Soho.security.inOperation){return false}var g=b.getAttribute("salt"),k=b.getElementsByTagName("input"),f=k[0],h=k[1],l=k[2],m=h.value;if(f.value.length==0){f.focus();return false}if(m.length==0){h.focus();return false}if(window.location.protocol!="https:"&&l.checked!==true){if(!confirm("This connection will be unsecured. Are you sure to continue?")){return false}}Soho.security.inOperation=true;b.style.display="none";m=Soho.security.sha1(f.value+":"+m);if(b.hasAttribute("apikey")){m="s+k:"+Soho.security.sha1(g+":"+m+":"+b.getAttribute("apikey"))}else{m="s:"+Soho.security.sha1(g+":"+m)}jQuery(Soho.security.vkb.div).hide().remove().appendTo("#viewLogin");h.value=m;if(l.checked===true){Soho.setStatus("Open secured channel...",Soho.status.WAIT);Soho.security.openAES(function(){Soho.setStatus("Authentication...",Soho.status.WAIT);var n={};n[f.getAttribute("name")]=f.value;n[h.getAttribute("name")]=m;Soho.security.authenticate(n);Soho.security.inOperation=false},function(){Soho.security.AES=null;Soho.setStatus("AES handshake failure",Soho.status.FAILURE);Soho.security.inOperation=false;setTimeout("WG.setView('login', null, true);",1500)})}else{Soho.security.AES=null;Soho.setStatus("Authentication...",Soho.status.WAIT);var d={};d[f.getAttribute("name")]=f.value;d[h.getAttribute("name")]=m;Soho.security.authenticate(d)}return false},authenticate:function(a){var b=function(d,g,f){Soho.setStatus("Authentication Failure: <em>"+f+"</em>",Soho.status.FAILURE,function(){Soho.setView("login",null,true)});if(console){console.error("[security] Authentication failure: "+f)}Soho.security.inOperation=false};var c=function(f,g,d){Soho.setStatus(null);if(console){console.log("[security] Authentication success!")}Soho.security.inOperation=false;Soho.welcome()};a.w="auth";Soho.ajax({url:Soho.appURL()+"ws.php",data:a,success:c,error:b})},AES:null,openAES:function(d,b){if(console){console.log("Open AES channel...")}if(Soho.security.AES==null){var a=Soho.security.random(32),c=new jsSHA(a,"ASCII");Soho.security.AES={hashObj:c,password:c.getHash("SHA-512","HEX")}}jQuery.jCryption.authenticate(Soho.security.AES.password,Soho.appURL()+"publickeys.php",Soho.appURL()+"handshake.php",function(){uidata.uiComponents.appName.setAttribute("class","securized");d()},function(){Soho.security.AES=null;uidata.uiComponents.appName.setAttribute("class","");b()})},aesEncrypt:function(a){if(a instanceof Object){for(let key in a){a[key]=Soho.security.aesEncrypt(a)}}return jQuery.jCryption.encrypt(""+a,Soho.security.AES.password)},aesDecrypt:function(a){return jQuery.jCryption.decrypt(""+a,Soho.security.AES.password)},vkb:{pwd:null,div:null,timer:null,key:null,shifted:false,shift:function(){for(var a=0;a<4;a++){document.getElementById("row"+a).style.display=this.shifted?"inherit":"none";document.getElementById("row"+a+"_shift").style.display=this.shifted?"none":"inherit"}this.shifted=!this.shifted},keypress:function(){switch(this.key){case"Backspace":case"&larr;":case"â†":if(Soho.security.vkb.pwd.value.length>0){Soho.security.vkb.pwd.value=Soho.security.vkb.pwd.value.substr(0,Soho.security.vkb.pwd.value.length-1)}break;case"Shift":this.shift();break;case"&lt;":Soho.security.vkb.pwd.value+="<";break;case"&gt;":Soho.security.vkb.pwd.value+=">";break;default:Soho.security.vkb.pwd.value+=this.key;break}this.timer=this.key=null}},random:function(f){var d="012345689ABCDEFGHIJKLMNOPRSTUVWXTZabcefghiklmopqrstuvwyz;:-.!@-_~$%*^+()[],/!|",c="",a=d.length;while(f-->0){var b=Math.floor(Math.random()*a);c+=d.substring(b,b+1)}return c},cookies:function(){var d=[];for(var b=0,a,f,c=document.cookie.split(";");b<c.length;b++){a=c[b].substr(0,c[b].indexOf("="));f=c[b].substr(c[b].indexOf("=")+1);a=a.replace(/^\s+|\s+$/g,"");d[a]=unescape(f)}return d},cookie:function(b){for(var c=0,a,f,d=document.cookie.split(";");c<d.length;c++){a=d[c].substr(0,d[c].indexOf("="));f=d[c].substr(d[c].indexOf("=")+1);a=a.replace(/^\s+|\s+$/g,"");if(b==a){return unescape(f)}}return null},phpSessionID:function(){return Soho.security.cookie("PHPSESSID")},sha1:function(s){var c=function(A,z){var y=(A<<z)|(A>>>(32-z));return y};var t=function(B){var A="";var z;var y;for(z=7;z>=0;z--){y=(B>>>(z*4))&15;A+=y.toString(16)}return A};var g;var w,u;var b=new Array(80);var m=1732584193;var k=4023233417;var h=2562383102;var f=271733878;var d=3285377520;var r,q,p,o,n;var x;var a=s.length;var l=[];for(w=0;w<a-3;w+=4){u=s.charCodeAt(w)<<24|s.charCodeAt(w+1)<<16|s.charCodeAt(w+2)<<8|s.charCodeAt(w+3);l.push(u)}switch(a%4){case 0:w=2147483648;break;case 1:w=s.charCodeAt(a-1)<<24|8388608;break;case 2:w=s.charCodeAt(a-2)<<24|s.charCodeAt(a-1)<<16|32768;break;case 3:w=s.charCodeAt(a-3)<<24|s.charCodeAt(a-2)<<16|s.charCodeAt(a-1)<<8|128;break}l.push(w);while((l.length%16)!=14){l.push(0)}l.push(a>>>29);l.push((a<<3)&4294967295);for(g=0;g<l.length;g+=16){for(w=0;w<16;w++){b[w]=l[g+w]}for(w=16;w<=79;w++){b[w]=c(b[w-3]^b[w-8]^b[w-14]^b[w-16],1)}r=m;q=k;p=h;o=f;n=d;for(w=0;w<=19;w++){x=(c(r,5)+((q&p)|(~q&o))+n+b[w]+1518500249)&4294967295;n=o;o=p;p=c(q,30);q=r;r=x}for(w=20;w<=39;w++){x=(c(r,5)+(q^p^o)+n+b[w]+1859775393)&4294967295;n=o;o=p;p=c(q,30);q=r;r=x}for(w=40;w<=59;w++){x=(c(r,5)+((q&p)|(q&o)|(p&o))+n+b[w]+2400959708)&4294967295;n=o;o=p;p=c(q,30);q=r;r=x}for(w=60;w<=79;w++){x=(c(r,5)+(q^p^o)+n+b[w]+3395469782)&4294967295;n=o;o=p;p=c(q,30);q=r;r=x}m=(m+r)&4294967295;k=(k+q)&4294967295;h=(h+p)&4294967295;f=(f+o)&4294967295;d=(d+n)&4294967295}x=t(m)+t(k)+t(h)+t(f)+t(d);return x.toLowerCase()},base64_encode:function(l){var f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var d,c,b,p,o,n,m,q,k=0,s=0,h="",g=[];if(!l){return l}do{d=l.charCodeAt(k++);c=l.charCodeAt(k++);b=l.charCodeAt(k++);q=d<<16|c<<8|b;p=q>>18&63;o=q>>12&63;n=q>>6&63;m=q&63;g[s++]=f.charAt(p)+f.charAt(o)+f.charAt(n)+f.charAt(m)}while(k<l.length);h=g.join("");var a=l.length%3;return(a?h.slice(0,a-3):h)+"===".slice(a||3)},base64_decode:function(k){var d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var c,b,a,o,n,m,l,p,h=0,q=0,f="",g=[];if(!k){return k}k+="";do{o=d.indexOf(k.charAt(h++));n=d.indexOf(k.charAt(h++));m=d.indexOf(k.charAt(h++));l=d.indexOf(k.charAt(h++));p=o<<18|n<<12|m<<6|l;c=p>>16&255;b=p>>8&255;a=p&255;if(m==64){g[q++]=String.fromCharCode(c)}else{if(l==64){g[q++]=String.fromCharCode(c,b)}else{g[q++]=String.fromCharCode(c,b,a)}}}while(h<k.length);f=g.join("");return f}};Soho.ui={createUIComponents:function(){if(console){console.log("[start] Create UI components...")}var b=document.createElement("div");b.setAttribute("id","container");b.onmousemove=function(){uidata.lastAction=new Date().getTime()};var k=document.createElement("header");b.appendChild(k);var m=document.createElement("div");m.setAttribute("id","top");k.appendChild(m);var l=document.createElement("div");l.setAttribute("id","appName");l.innerHTML=Soho.util.htmlspecialchars(Soho.appName());m.appendChild(l);var f=document.createElement("div");f.setAttribute("id","live");m.appendChild(f);var d=document.createElement("ul");d.setAttribute("id","menu");k.appendChild(d);var g=document.createElement("div");g.setAttribute("id","main");b.appendChild(g);var a=document.createElement("div");a.setAttribute("id","wrapper");g.appendChild(a);var h=document.createElement("div");h.setAttribute("id","status");k.appendChild(h);var n=document.createElement("div");n.setAttribute("id","locker");b.appendChild(n);n.oncontextmenu=function(){return false};n.onmousedown=function(){return false};n.onmouseup=function(){return false};var c=document.createElement("div");c.setAttribute("id","menuOpts");k.appendChild(c);return{container:b,header:k,top:m,appName:l,live:f,menu:d,main:g,wrapper:a,status:h,locker:n,menuOpts:c}},bindEvents:function(){if(console){console.log("[start] Bind UI events...")}document.location.hash="";jQuery(window).bind("hashchange",function(c){if(!(document.location.hash in Soho.ui.viewHistory)){return}var b=Soho.ui.viewHistory[document.location.hash];if(console){console.log("[ui] Set view: "+b.name)}var a;if(viewdata.loaded[b.name]){a=viewdata.loaded[b.name]}else{a=new Soho.View(b.name);viewdata.loaded[b.name]=a}Soho.ui.removeCurrentView();jQuery(uidata.uiComponents.wrapper).scrollTop(0);Soho.ui.currentView=a;uidata.uiComponents.wrapper.appendChild(a.node);Soho.trigger("viewChange",a.name);if(!a.display(b.param,(b.noCache===true),b.hash)&&a.dist!=Soho.View.DistributionModel.KEEP_ALIVE){Soho.ui.getTrayIcon("power").setNotification("This page has been restored from cache. Click here to refresh this page.",function(){Soho.setView(a.name,null,true)},3000);Soho.trigger("viewRestored",a.name)}Soho.ui.viewHistory[document.location.hash].noCache=false;if(b.hash){document.location.hash=b.hash}Soho.trigger("viewChanged",a.name)}).resize(function(a){jQuery(".fit-height").trigger("fitheight")})},viewCount:1,viewHistory:{},setView:function(c,f,b,d){var a="#view-"+Soho.ui.viewCount++;Soho.ui.viewHistory[a]={name:c,param:f,noCache:b,hash:d};if("localStorage" in window&&c!="login"){window.localStorage.setItem("WG.defaultView",c)}Soho.setStatus(null);Soho.search.setDefault();document.location.hash=a},currentView:null,removeCurrentView:function(){uidata.uiComponents.wrapper.innerHTML="";if(Soho.ui.currentView!=null){if(Soho.ui.currentView.xhr){if(console){console.log("[ui] Stop loading for view: "+Soho.ui.currentView.name)}Soho.ui.currentView.xhr.abort()}Soho.trigger("viewRemoved",Soho.ui.currentView.name);Soho.ui.currentView=null}},createMenu:function(d){for(var m=0,h=d.length;m<h;m++){var r=d[m];var q=document.createElement("li");q.setAttribute("class","top-level-menu module-"+r.module);if("subs" in r){q.onmouseover=function(){jQuery("ul",this).show()};q.onmouseout=function(){jQuery("ul",this).hide()}}var p=document.createElement("a");p.setAttribute("view",r.view);p.onclick=function(){Soho.setView(this.getAttribute("view"))};p.innerHTML=Soho.util.htmlspecialchars(r.label);q.appendChild(p);if("subs" in r){var n=document.createElement("ul");q.appendChild(n);for(var g=0,f=r.subs.length;g<f;g++){var b=r.subs[g],o=document.createElement("li"),c=document.createElement("a");c.innerHTML=Soho.util.htmlspecialchars(b.label);c.setAttribute("view",b.view);c.onclick=function(){Soho.setView(this.getAttribute("view"));this.parentNode.parentNode.style.display="none"};o.appendChild(c);n.appendChild(o)}}uidata.uiComponents.menu.appendChild(q)}var p=document.createElement("a");p.setAttribute("class","toggleMenu");p.onclick=function(){Soho.ui.toggleMenuVisibility()};uidata.uiComponents.menuOpts.appendChild(p)},destroyMenu:function(){uidata.uiComponents.menu.innerHTML=""},setMenuVisible:function(a){if(a){jQuery(uidata.uiComponents.menu).removeClass("wide");jQuery(uidata.uiComponents.wrapper).removeClass("fit-width");jQuery(uidata.uiComponents.menuOpts).removeClass("min")}else{jQuery(uidata.uiComponents.menu).addClass("wide");jQuery(uidata.uiComponents.wrapper).addClass("fit-width");jQuery(uidata.uiComponents.menuOpts).addClass("min")}},toggleMenuVisibility:function(){Soho.ui.setMenuVisible(jQuery(uidata.uiComponents.menuOpts).hasClass("min"))},createTrayIcons:function(){if(!Soho.isLogged()){return false}Soho.util.each(uidata.trayIcons,function(a){Soho.ui.initTrayIcon(a)});return true},initTrayIcon:function(a){if(a.initialized){return}if(console){console.log("[ui] Init TrayIcon: "+a.name)}a.node=document.createElement("div");a.node.setAttribute("id",a.name);a.node.setAttribute("class","tray");if("onClick" in a.data){a.onclick_substitut=a.data.onClick;a.a=document.createElement("a");a.a.onclick=function(){a.onclick_substitut()};a.node.appendChild(a.a)}if("onInit" in a.data){a.onInit=a.data.onInit;a.onInit()}uidata.uiComponents.live.appendChild(a.node);a.initialized=true;if("onAppear" in a.data){a.onAppear=a.data.onAppear;a.onAppear()}},addTrayIcon:function(a){if(!a.name){alert("Error in Soho.ui.addTrayIcon: icon name missing");return null}var b;if(!(a.name in uidata.trayIcons)){b=new Soho.TrayIcon(a);uidata.trayIcons[a.name]=b}else{b=uidata.trayIcons[a.name]}if(Soho.isLogged()&&uidata.uiComponents&&!b.initialized){Soho.ui.initTrayIcon(b)}return b},removeTrayIcon:function(a){},removeAllTrayIcons:function(){if(console){console.warn("[todo] WG.ui.removeAllTrayIcons()")}},getTrayIcons:function(){return uidata.trayIcons},getTrayIcon:function(a){return uidata.trayIcons.hasOwnProperty(a)?uidata.trayIcons[a]:null},getTrayIconsCount:function(){return Object.keys(uidata.trayIcons).length},TrayMenuStack:{TOP:0,MIDDLE:5,BOTTOM:10},addTrayMenuItem:function(f,d,c,g,b){var a=document.createElement("li");a.setAttribute("name",f);if(b){a.setAttribute("vkb",b)}a.innerHTML=d;a.onclick=function(h){jQuery(Soho.ui.getTrayIcon("power").trayMenu).hide();g(h)};Soho.ui.getTrayIcon("power").trayMenu.appendChild(a)},removeTrayMenuItem:function(a){},removeAllTrayMenuItems:function(){Soho.ui.getTrayIcon("power").trayMenu.innerHTML=""},theme:{rgb2hex:function(a){a=a.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);function b(c){return("0"+parseInt(c).toString(16)).slice(-2)}return b(a[1])+b(a[2])+b(a[3])},getBackgroundColor:function(){return Soho.ui.theme.rgb2hex(jQuery("body").css("background-color"))},getForegroundColor:function(){return Soho.ui.theme.rgb2hex(jQuery("body").css("color"))}}};Soho.View=function(b){this.name=b;this.dist=Soho.View.DistributionModel.LOCAL_CACHE;this.loadedTime=0;this.loadedUrl=null;this.localCacheAge=120000;if(b in Soho.viewdata.available){var c=Soho.viewdata.available[b];if("dist" in c){if(c.dist in Soho.View.DistributionModel){this.dist=Soho.View.DistributionModel[c.dist]}}}if(this.dist===Soho.View.DistributionModel.CONTINUE){this.isAllDataFragmentsLoaded=false;this.currentFragmentCursor=0;var a=this;jQuery(window).scroll(function(){if(jQuery(window).scrollTop()==jQuery(document).height()-jQuery(window).height()){a.nextFragment()}})}this.node=document.createElement("div");this.node.setAttribute("class","view fit-height");this.node.setAttribute("id","view-"+b);this.xhr=null};Soho.View.prototype.getURL=function(b){var a=[Soho.appURL(),"view.php?v=",escape(this.name)];if(b instanceof Object){for(let key in b){a.push("&");a.push(encodeURIComponent(key));a.push("=");a.push(encodeURIComponent(b[key]))}}return a.join("")};Soho.View.prototype.display=function(d,a,c){var b=this.getURL(d);if(console){console.log("[ui] View URL: "+b+" (cache="+(a?"no":"yes")+", current="+(b!=this.loadedUrl?"no":"yes")+")")}if(a||b!=this.loadedUrl){this.download(b,c);return true}switch(this.dist){case Soho.View.DistributionModel.KEEP_ALIVE:if(!this.loadedUrl){this.download(b,c);return true}return false;case Soho.View.DistributionModel.REFRESH:this.download(b,c);return true;case Soho.View.DistributionModel.LOCAL_CACHE:default:if(!this.loadedUrl){this.download(b,c);return true}else{if(new Date().getTime()-this.loadedTime>this.localCacheAge){this.download(b,c);return true}}return false}};Soho.View.prototype.setContents=function(a){jQuery(this.node).html(a);jQuery(window).trigger("resize")};Soho.View.prototype.download=function(a,b){this.loadedUrl=null;this.node.innerHTML="";Soho.setStatus("Loading view...",Soho.status.WAIT);if(console){console.log("[ajax] GET "+a+" (AES="+(Soho.security.AES==null?"off":"on")+", cache=off)")}this.xhr=jQuery.ajax({url:a,cache:false,context:this,dataType:Soho.security.AES!=null?"text":"html",type:"GET",success:function(d,f,c){this.xhr=null;this.loadedUrl=a;this.loadedTime=new Date().getTime();if(Soho.security.AES!=null){Soho.setStatus("Decrypting data...",Soho.status.WAIT);d=Soho.security.aesDecrypt(d)}Soho.setStatus(null);this.setContents(d);if(typeof b=="string"){document.location.hash="#"+b}Soho.trigger("viewLoaded",this.name)},error:function(c,f,d){this.xhr=null;Soho.setStatus("Unable to get this view: <em>"+d+" ("+f+")</em>",Soho.status.FAILURE,function(){if(this.refresh){this.refresh()}else{Soho.setStatus("<b>Fatal Error</b>: please restart using F5 on your keyboard",Soho.status.FAILURE)}})}})};Soho.util.implementListenerPattern(Soho.View.prototype);Soho.View.applyStandardBehavior=function(a){jQuery(a).on("click",'a[href]:not([target="_blank"])',function(b){return !Soho.View.handleLink(this.getAttribute("href"),b)}).on("submit","form",function(b){return !Soho.View.handleForms(this,b)}).on("click","ul.tabmenu li a",function(c){var b=this.parentNode,d=b.parentNode;jQuery("li.selected",d).removeClass("selected");jQuery(b).addClass("selected");jQuery(".tabcontent.tab-"+d.getAttribute("tab"),a).removeClass("selected");jQuery(".tabcontent"+this.getAttribute("href"),a).addClass("selected");c.preventDefault();return false}).on("click","ul.view-topbar-menu > li",function(b){}).on("fitheight",".fit-height",function(){var c=jQuery(this),b=jQuery("body").height(),d=0,f=0;f=+parseInt(c.css("padding-top"),10)+parseInt(c.css("padding-bottom"),10)+parseInt(c.css("margin-top"),10)+parseInt(c.css("margin-bottom"),10)+parseInt(c.css("borderTopWidth"),10)+parseInt(c.css("borderBottomWidth"),10);d=b-f-c.offset().top;c.css("height",d+"px")}).on("keydown","textarea.elastic",function(){this.style.height="";this.rows=this.value.split("\n").length;this.style.height=this.scrollHeight+"px"})};jQuery.View.handleLink=function(a){if(a.substr(0,1)=="?"){a="index.php"+a}else{if(a.substr(0,10)!="index.php?"){return false}}a=a.substr(10).split("&");var h=null,f=null,c={},g=0,d=a.length;for(;g<d;g++){var b=a[g];if(b.indexOf("#")!==-1){f=unescape(b.substr(b.indexOf("#")+1,b.length));b=b.substr(0,b.indexOf("#"))}var k=b.split("="),l=k.shift();k=k.join();if(l=="view"||l=="v"){h=k}else{c[l]=unescape(k)}}if(h!=null){jQuery.setView(h,c,false,f);return true}return false};jQuery.View.handleForms=function(c,a){var p=jQuery(c),k={};if(p.hasAttr("enctype")&&c.enctype=="multipart/form-data"){throw"Not implemented yet"}var g=p.attr("action"),b=Soho.util.parse_url(g),f=("query" in b)?b.query.split("&"):[],l=0,h=f.length;for(;l<h;l++){var d=f[l];var n=d.split("="),o=n.shift();n=n.join();if(o=="view"||o=="v"){k.v=n}else{k[o]=unescape(n)}}jQuery("input,textarea,select",c).each(function(){var q=jQuery(this);if(q.hasAttr("name")){if(q.is(":disabled")){return}if(q.attr("type")=="checkbox"){if(q.is(":checked")){k[this.name]=this.value}q.attr("disabled","disabled");return}if(q.attr("name")=="view"&&!("v" in k)){k.v=q.val()}else{k[this.name]=q.val()}q.attr("disabled","disabled")}});Soho.setStatus("Sending data...",Soho.status.WAIT);var m=Soho.ui.currentView;Soho.ajax({url:"view.php",data:k,dataType:"html",success:function(q){Soho.setStatus(null);if(console){console.log("Loaded URL: "+m.getURL(q))}m.loadedUrl=m.getURL(q);m.setContents(q)},error:function(q,s,r){Soho.setStatus("Unable to post this form: "+r,Soho.status.FAILURE,function(){Soho.setStatus(null)},"close")}});a.preventDefault();return true};Soho.View.DistributionModel={REFRESH:1,LOCAL_CACHE:2,KEEP_ALIVE:3,CONTINUE:4,PAGINATION:5};Soho.View.prototype.supportDataFragments=function(){return(this.dist===Soho.View.DistributionModel.CONTINUE||this.dist===Soho.View.DistributionModel.PAGINATION)};Soho.View.prototype.isAllDataFragmentsLoaded=false;Soho.View.prototype.currentFragmentCursor=0;Soho.View.prototype.setDataFragment=function(b,g,d,f,c){var a=this;console.log("Load fragment: "+g);Soho.ajax({url:Soho.appURL()+"view.php?v="+escape(this.name),dataType:"html",cache:(!c)?false:true,data:{frag:g},success:function(k,l,h){if(f){b.innerHTML=k}else{b.innerHTML+=k}if(h.status!=206){a.isAllDataFragmentsLoaded=true;a.trigger("fragmentsLoaded",{frag:g,opts:d,status:h.status})}else{a.trigger("fragmentLoaded",{frag:g,opts:d,status:h.status})}a.currentFragmentCursor=g},error:function(h,l,k){console.log("Fragment load ERROR: "+l+" ("+k+")")}})};Soho.View.prototype.nextFragment=function(){if(!this.supportDataFragments()){throw"Invalid distribution model"}if(this.isAllDataFragmentsLoaded){return}this.setDataFragment(document.getElementById("dataContainer"),this.currentFragmentCursor+1,null,false,true)};Soho.TrayIcon=function(a){this.name=a.name;this.data=a;this.badgeText=null;this.notification=null;this.node=null;this.initialized=false};Soho.TrayIcon.prototype.setBadgeText=function(b){if(!b){if(this.badgeText){jQuery(this.badgeText).remove();this.badgeText=null}return this}if(!this.badgeText){this.badgeText=document.createElement("span");this.badgeText.setAttribute("class","badge");this.node.appendChild(this.badgeText);var a=this;this.badgeText.onclick=function(){jQuery(a.a).click()}}this.badgeText.innerHTML=b;return this};Soho.TrayIcon.prototype.getBadgeText=function(){return(this.badgeText)?this.badgeText.innerHTML:null};Soho.TrayIcon.prototype.setLoadingIndicator=function(a){if(a){jQuery(this.node).addClass("loading")}else{jQuery(this.node).removeClass("loading")}return this};Soho.TrayIcon.prototype.hasLoadingIndicator=function(){return jQuery(this.node).hasClass("loading")};Soho.TrayIcon.prototype.setNotification=function(d,c,b){var a=this;if(!d){if(this.notification){jQuery(this.notification).stop().fadeTo(1000,0,function(){jQuery(a.notification).remove();a.notification=null})}return this}if(!this.notification){this.notification=document.createElement("div");this.notification.setAttribute("class","notification");jQuery(this.notification).fadeTo(0,0);this.node.appendChild(this.notification)}if(c){this.notification.onclick=c}this.notification.innerHTML=d;jQuery(this.notification).stop().fadeTo(1000,0.9);if(this.notificationThread!=null){clearTimeout(this.notificationThread)}if(!b){b=6000}if(b){setTimeout(function(){a.setNotification(null)},b)}return this};Soho.util.implementListenerPattern(Soho.TrayIcon.prototype);Soho.LiveService=function(){var a=this;this.thead=setInterval(function(){a.refresh()},10000);if(console){console.log("[live] Start live service...")}};Soho.LiveService.prototype.refresh=function(){if(!Soho.live){return}var a=this.getParameters();if(!a){return}Soho.ajax({url:Soho.appURL()+"live.php",data:a,success:function(b){if("error" in b){Soho.ui.getTrayIcon("power").setNotification("Error in live service.");return}Soho.lastUpdate=b.serverTime;Soho.live.propagation(b)},error:function(){Soho.ui.getTrayIcon("power").setNotification("Unable to connect live service.")}})};Soho.LiveService.prototype.getParameters=function(){var c=0,b={};for(let listener in Soho.live.bind){var a=Soho.live.bind[listener];if(!("view" in a)||(Soho.ui.currentView!=null&&Soho.ui.currentView.name===a.view)){b[a.event]=1;c++}}if(c<1){return null}var d=[];for(event in b){d.push(event)}return{t:Soho.lastUpdate,l:d.join("|")}};Soho.LiveService.prototype.stop=function(){if(console){console.log("[live] Stop live service...")}clearInterval(this.thread)};Soho.LiveService.prototype.bind={};Soho.LiveService.prototype.propagation=function(b){for(let listener in Soho.live.bind){var a=Soho.live.bind[listener];if(!("view" in a)||(Soho.ui.currentView!=null&&Soho.ui.currentView.name===a.view)){if(a.event in b){a.onChange(b[a.event])}}}};Soho.ui.addTrayIcon({name:"power",onInit:function(){jQuery(this.node).addClass("icon");this.trayMenu=document.createElement("ul");this.trayMenu.setAttribute("class","drop-down");this.node.appendChild(this.trayMenu)},onClick:function(){jQuery(this.trayMenu).toggle()}});Soho.ui.addTrayIcon({name:"clock",onInit:function(){this.node.innerHTML="--:--";this.updateClock=function(){var c=Soho.time.getServerTime();var b=c.getHours(),a=c.getMinutes();if(b<10){b="0"+b}if(a<10){a="0"+a}this.node.innerHTML=b+":"+a}},onHide:function(){clearInterval(this.intervalThread)},onAppear:function(){this.updateClock();var a=this;this.intervalThread=setInterval(function(){a.updateClock()},5000)}});Soho.search={trayIcon:null,onQuickSearch:function(b,a,c){},onQuickAction:function(b,a,c){},onReset:function(a,b){},setDefault:function(){Soho.search.onQuickSearch=function(query){jQuery("[quicksearch]").each(function(){if(this.getAttribute("quicksearch").toLowerCase().match(query)){jQuery(this).show()}else{jQuery(this).hide()}});return false};Soho.search.onQuickAction=function(query,event,field){var v=jQuery(".[quicksearch]:visible");if(v.size()===1){let url=v.attr("url");if(url!=null&&url.length>0){if(url.substr(0,11)=="javascript:"){Soho.search.onReset(event,field);let e=v.get(0);e.qstmp=function(d){eval(d)};e.qstmp(url.substr(11));e.qstmp=null}else{event.preventDefault();Soho.View.handleLink(url)}return false}}return true};Soho.search.onReset=function(event,field){if(event){event.preventDefault()}jQuery("[quicksearch]").show();if(field){jQuery(field).val("")}return false};if(Soho.search.trayIcon.input){Soho.search.onReset(null,Soho.search.trayIcon.input)}},quickSearch:function(a){Soho.search.onQuickSearch(a)}};window.quickSearch=function(a){Soho.search.quickSearch(a)};Soho.search.trayIcon=Soho.ui.addTrayIcon({name:"searchbox",onInit:function(){Soho.search.setDefault();this.input=document.createElement("input");this.input.setAttribute("type","search");this.input.setAttribute("id","qs");this.input.setAttribute("name","qs");this.input.setAttribute("placeholder","Search...");jQuery(this.input).keyup(function(c){var b=jQuery.trim(jQuery(this).val());if(b.length>0){if(c.keyCode==13){if(!Soho.search.onQuickAction(b,c,this)){return false}Soho.setView("search",{q:b});return false}return Soho.search.onQuickSearch(b,c,this)}else{return Soho.search.onReset(c,this)}});this.node.appendChild(this.input);var a=this;this.getFocus=function(){a.input.focus()};Soho.bind("viewChange",this.getFocus)},onClick:function(){},onMouseOver:function(){},onHide:function(){},onAppear:function(){},onDestroy:function(){window.quickSearch=Soho.quickSearch=undefined;Soho.unbind("*",this.getFocus)}});