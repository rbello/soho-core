<?php if (!interface_exists('DatabaseConnector')) {interface DatabaseConnector {public function query($sql);public function isDatabaseReady();public function escapeString($string);public function connect();public function close();public function createDatetime($timestamp);public function createDate($timestamp);public function name();public function __toString();}class DatabaseConnectorException extends Exception {public function __construct($msg) {parent::__construct($msg);}}class DatabaseConnectorNotReadyException extends DatabaseConnectorException {public function __construct($message='connector not ready') {parent::__construct($message);}}class DatabaseQueryException extends DatabaseConnectorException {public function __construct($msg, $sql) {parent::__construct($msg);}}class InvalidDatabaseQueryException extends DatabaseConnectorException {public function __construct($sql) {parent::__construct($sql);}}interface DBResultSet extends Iterator {public function getRowCount();}}if (!class_exists('DBM')) {class DBM {private static $databases = array();public static function installDatabase($id, DatabaseConnector $db) {self::$databases[$id] = $db;}public static function uninstallDatabase($id) {unset(self::$databases[$id]);}public static function isDatabaseInstalled($id) {return array_key_exists($id, self::$databases);}public static function getDatabase($id) {return array_key_exists($id, self::$databases) ? self::$databases[$id] : null;}public static function get($id) {return self::getDatabase($id);}public static function connectAllDatabases() {foreach (self::$databases as $database) {if (!$database->isDatabaseReady()) {$c = $database->connect();if (is_array($c)) {throw new DatabaseConnectorException('Unable to connect database '.$database.' ('.$c[0].', '.$c[1].', '.$c[2].')');}}}}public static function createDatabase($id='main', $type='mysql', $host='localhost', $user='root', $password='', $dbname, $dbprefix='', $connectondemand=true, $install=true) {$type = strtolower($type);if ($type == 'mysql') {$db = new MySQLDatabaseConnector($host, $user, $password, $dbname, $dbprefix, $connectondemand, $id);if ($install) {self::installDatabase($id, $db);}}else {throw new Exception('Invalid database type: '.$type);}return $db;}}class DatabaseConnectorManager extends DBM { }}if (!class_exists('DBResultRow')) {final class DBResultRow {protected $data;public function __construct($data) {$this->data = $data;}public function getFieldsCount() {return sizeof($this->data);}public function field($name) {return $this->fieldExists($name) ? $this->data[$name] : null;}public function fieldExists($name) {return array_key_exists($name, $this->data);}public function all() {return $this->data;}public function fields() {return array_keys($this->data);}public function getField($name) {return $this->field($name);}public function __get($name) {return $this->field($name);}public function get($name) {return $this->field($name);}public function __toString() {$r = array();foreach ($this->data as $k => $v) {$r[] = "$k=$v";}return 'DBResultRow['.implode(',', $r).']';}}}if (!class_exists('MySQLDatabaseConnector')) {final class MySQLDatabaseConnector implements DatabaseConnector {private $connected = false;private $host;private $user;private $password;private $database;private $prefix;private $connectondemand;private $id;public $resource = null;public function __construct($host, $user, $password, $database, $prefix='', $connectondemand=true, $id) {$this->host = (string) $host;$this->user = (string) $user;$this->password = (string) $password;$this->database = (string) $database;$this->prefix = (string) $prefix;$this->connectondemand = (boolean) $connectondemand;$this->id = (string) $id;}public function isConnected() {return $this->connected;}public function name() {return $this->id;}public function getName() {return $this->id;}public function connect() {if ($this->isConnected()) return array('not_connected', null, null);$error = false;$link = @mysql_connect($this->host, $this->user, $this->password, true) or $error = true;if ($error || !$link) {return array('mysql_connect',mysql_error(),mysql_errno());}if (@!mysql_select_db($this->database, $link)) $error = true;if ($error) {return array('mysql_select_db',mysql_error($link),mysql_errno($link));}$this->connected = true;$this->resource =& $link;return null;}public function getLastError() {if ($this->resource == null) return @mysql_error();else return @mysql_error($this->resource);}public function getHost() {return $this->host;}public function getUser() {return $this->user;}public function getDatabaseName() {return $this->database;}public function isConnectOnDemand() {return $this->connectondemand;}public function isDatabaseReady() {return $this->connected;}public function query($sql) {if (!$this->isDatabaseReady()) {if ($this->connectondemand) {$c = $this->connect();if ($c != null) {throw new DatabaseConnectorNotReadyException('Unable to connect '.$this.' ('.$c[0].', '.$c[1].', '.$c[2].')');}$c = null;}else throw new DatabaseConnectorNotReadyException();}$error = null;$sql = trim($sql);$function = strtoupper(array_shift(preg_split('/[\s]+/', $sql)));switch ($function) {case 'SELECT' :$query = @mysql_query($sql, $this->resource) or $error = mysql_error();if ($error !== null) {throw new DatabaseQueryException($error, $sql);}return new MySQLResultSet($query); break;case 'INSERT' :$query = @mysql_query($sql, $this->resource) or $error = mysql_error();if (!$query || $error !== null) {throw new DatabaseQueryException($error, $sql);}$r = @mysql_insert_id($this->resource);if (is_int($r)) return $r;return -1;break;case 'CREATE' :$query = @mysql_query($sql, $this->resource) or $error = mysql_error();if (!$query || $error !== null) {throw new DatabaseQueryException($error, $sql);}return (bool) $query;break;case 'TRUNCATE' :$query = @mysql_query($sql, $this->resource) or $error = mysql_error();if (!$query || $error !== null) {throw new DatabaseQueryException($error, $sql);}return (bool) $query;break;case 'DROP' :$query = @mysql_query($sql, $this->resource) or $error = mysql_error();if (!$query || $error !== null) {throw new DatabaseQueryException($error, $sql);}return (bool) $query;break;case 'SHOW' :$query = @mysql_query($sql, $this->resource) or $error = mysql_error();if ($error !== null) {throw new DatabaseQueryException($error, $sql);}return new MySQLResultSet($query);break;case 'DESCRIBE' :throw new Exception('Not implemented yet (DESCRIBE)');break;case 'EXPLAIN' :throw new Exception('Not implemented yet (EXPLAIN)');break;case'UPDATE' :$query = @mysql_query($sql, $this->resource) or $error = mysql_error();if (!$query || $error !== null) {throw new DatabaseQueryException($error, $sql);}$r = @mysql_affected_rows($this->resource);if (is_int($r)) return $r;return -1;break;case 'DELETE' :$query = @mysql_query($sql, $this->resource) or $error = mysql_error();if (!$query || $error !== null) {throw new DatabaseQueryException($error, $sql);}$r = @mysql_affected_rows($this->resource);if (is_int($r)) return $r;return -1;break;default :throw new InvalidDatabaseQueryException('Unknown mysql function '.$function, $sql);}}public function getPrefix() {return $this->prefix;}public function escapeString($string) {if (!isset($string) || $string === null) return 'NULL';else if ($string === true) return 'TRUE';else if ($string === false) return 'FALSE';else if (!is_string($string)) $string = (string) $string;if ($this->connected) return mysql_real_escape_string($string);return addslashes($string);}public function strtotime($string) {if (!isset($string)) return 0;if (!is_string($string)) return 0;return strtotime($string);}public function createDatetime($timestamp) {return date('Y-m-d H:i:s', $timestamp);}public function createDate($timestamp) {return date('Y-m-d', $timestamp);}public function close() {if (!$this->connected) return false;$this->connected = false;return @mysql_close($this->resource);}public function __toString() {return 'MySQL database '.$this->database.'@'.$this->host;}}}if (!class_exists('MySQLResultSet')) {final class MySQLResultSet implements DBResultSet {private $resource;private $rowCount = 0;private $index = null;private $current = null;public function __construct($resource) {$this->resource = $resource;$this->rowCount = @mysql_num_rows($this->resource);if ($this->rowCount > 0) {$this->index = 0;}}public function destroy() {@mysql_free_result($this->resource);}public function getRowCount() {return $this->rowCount;}public function count() {return $this->rowCount;}public function size() {return $this->rowCount;}public function rewind() {if ($this->rowCount > 0) {$this->index = 0;return @mysql_data_seek($this->resource, 0);}return false;}public function current() {if ($this->current == null) {$this->next();}return $this->current;}public function key() {return $this->index;}public function next() {$row = @mysql_fetch_assoc($this->resource);if ($this->current !== false) {$this->current = new DBResultRow($row);$this->index++;}else {$this->current = null;}return $this->current;}public function valid() {if ($this->index === null) return false;if ($this->index < 0) return false;if ($this->index > $this->rowCount) return false;return true;}public function isEmpty() {return $this->rowCount <= 0;}public function all() {$r = array();foreach ($this as $row) {$r[] = $row->all();}return $r;}public function __toString() {return 'MySQLResultSet['.$this->rowCount.']';}}}if (!class_exists('FakeDatabaseConnector')) {class FakeDatabaseConnector implements DatabaseConnector {public function __construct() {}public function isConnected() {return true;}public function connect() {return null;}public function isDatabaseReady() {return $this->connected;}public function name() {return 'fake';}public function query($sql) {$c = strtoupper(substr(trim($sql), 0, 15));$error = null;if (substr($c, 0, 7) == 'SELECT ') {echo $sql;return null;}else if (substr($c, 0, 7) == 'INSERT ') {echo $sql;return -1;}else if (substr($c, 0, 7) == 'CREATE ') {echo $sql;return true;}else if (substr($c, 0, 9) == 'TRUNCATE ') {echo $sql;return true;}else if (substr($c, 0, 5) == 'DROP ') {echo $sql;return true;}else if (substr($c, 0, 5) == 'SHOW ') {echo $sql;return null;}else if (substr($c, 0, 9) == 'DESCRIBE ') {echo $sql;return null;}else if (substr($c, 0, 8) == 'EXPLAIN ') {echo $sql;return null;}else if (substr($c, 0, 7) == 'UPDATE ') {echo $sql;return 0;}else if (substr($c, 0, 7) == 'DELETE ') {echo $sql;return 0;}throw new InvalidDatabaseQueryException($sql);}public function escapeString($string) {if (!isset($string) || $string === null) return 'NULL';else if ($string === true) return 'TRUE';else if ($string === false) return 'FALSE';else if (!is_string($string)) $string = (string) $string;return addslashes($string);}public function createDatetime($timestamp) {return date('Y-m-d H:i:s', $timestamp);}public function createDate($timestamp) {return date('Y-m-d', $timestamp);}public function close() {return true;}public function __toString() {return 'FakeDatabaseConnector';}}}if (!interface_exists('ModelBuilder')) {interface ModelBuilder {}define('NOT', '!=');define('EQUALS', '=');define('SUPERIOR', '>');define('INFERIOR', '<');define('ASC', 'ASC');define('DESC', 'DESC');class QueryBuilder {protected $_db;protected $_tablename;protected $_builder = null;protected $_where;protected $_order;protected $_limit;public function __construct($db, $tablename) {if ($db instanceof DatabaseConnector) {$this->_db = $db;}else {$this->_db = DatabaseConnectorManager::getDatabase((string) $db);}$this->_tablename = (string) $tablename;$this->reset();}public function reset() {$this->_where = array();$this->_order = null;$this->_limit = null;}public function __call($name, $args) {$name = strtolower($name);if (substr($name, 0, 8) == 'filterby') {$field = substr($name, 8);$this->_where[] = '`'.$this->_tablename.'`.`' . $field . "` = '" . $this->_db->escapeString($args[0]) . "'";}else if (substr($name, 0, 7) == 'orderby') {$field = substr($name, 7);$this->_order = '`'.$this->_tablename.'`.`' . $field . '`';if (sizeof($args) > 0) {$order = strtoupper($args[0]);if ($order == ASC || $order == DESC) {$this->_order .= ' ' . $order;}}}else if (substr($name, 0, 5) == 'where') {if (strlen($name) > 5) {$field = substr($name, 5);list($operator, $condition) = $args;}else {list($field, $operator, $condition) = $args;}$this->_where[] = '`'.$this->_tablename.'`.`' . $field . '` ' . $operator . " '" . $this->_db->escapeString($condition) . "'";}return $this;}public function setModelBuilder(ModelBuilder $builder=null) {$this->_builder = $builder;}public function limit($n) {$this->_limit = intval($n);return $this;}public function find() {return $this->execute();}public function run() {return $this->execute();}public function exec() {return $this->execute();}public function execute() {$r = $this->_db->query($this->query());return $r;}public function query() {$sql = 'SELECT ';$sql .= "\n *";$sql .= "\nFROM `".$this->_tablename.'`';if (sizeof($this->_where) > 0) {$sql .= "\nWHERE\n\t" . implode("\n AND\t", $this->_where);}if ($this->_order !== null) {$sql .= "\nORDER BY " . $this->_order;}if ($this->_limit !== null) {$sql .= "\nLIMIT " . $this->_limit;}return $sql . ';';}public function __toString() {return $this->query();}}}if (!class_exists('ModelManager')) {final class ModelManager {public static $PATH = '{here}/models/model.{name/l}.php';protected static $data = array();public static function get($name) {global $_DB;if (array_key_exists(strtolower($name), self::$data)) {return self::$data[strtolower($name)];}else {$path = str_replace(array('{here}', '{name}', '{name/l}'),array(dirname(__FILE__), $name, strtolower($name)),self::$PATH);if (is_file($path)) {require_once  $path;return self::get($name);}}$traces = debug_backtrace();$traces = $traces[0]['file'] == __FILE__ ? $traces[1] : $traces[0];trigger_error("Model not found '$name', called in {$traces['file']} on line {$traces['line']}", E_USER_ERROR);exit();}public static function add($name, MoodelStruct $model, $autoinstall=false) {self::$data[strtolower($name)] = $model;if ($autoinstall) {$model->createTable();}}}}if (!class_exists('MoodelStruct')) {class MoodelStruct {public $_db;protected $_name;protected $_fields = array();protected $_primary = null;protected $_hasForeignKey = false;protected $_factoryClass = 'Moodel';public $debug_out = false;public function __construct(DatabaseConnector $db, $name, $fields) {$this->_db = $db;$name = trim($name);$this->_name = strtolower($name);foreach ($fields as $field => $type) {$type = $this->prepareType($type);$this->_fields[$field] = $type;if (in_array('primary_key', $type['mods'])) {if ($this->_primary != null) {throw new Exception('[Moodel] Invalid declaration "primary_key" for field "'.$field.'" : allready exists (field "'.$this->_primary.'")');}$this->_primary = $field;}}ModelManager::add($this->_name, $this);if (!class_exists($name) && !class_exists($this->_name) && !interface_exists($name) && !interface_exists($this->_name)) {$this->createClass();}}protected function createClass() {$php = 'class ' . $this->_name . ' {';$php .= 'public static $model = null;';$php .= 'public static function all() { return self::$model->all(); }';$php .= 'public static function get() { return self::$model->new; }';$php .= 'public static function query() { return self::$model->query; }';$php .= 'public static function primary() { return self::$model->primary(); }';$php .= 'public static function fields() { return self::$model->fields(); }';$php .= 'public static function dbfields() { return self::$model->dbfields(); }';$php .= 'public static function drop() { return self::$model->drop(); }';$php .= 'public static function createTable() { return self::$model->createTable(); }';$php .= '}';eval($php);eval($this->_name . '::$model = ModelManager::get("' . $this->_name . '");');}public function prepareType($type) {$foreign = null;$type = explode(':', $type);$mods = sizeof($type) > 1 ? explode(',', $type[1]) : array();$type = $type[0];foreach ($mods as $k => $mod) {if (substr($mod, 0, 11) == 'foreign_key' && strlen($mod) > 11) {$mods[$k] = 'foreign_key';$foreign = explode('=', substr($mod, 12, -1));if (strtolower($foreign[0]) == $this->_name) {$model = $this;}else {$model = ModelManager::get($foreign[0]);}if (!$model) {throw new Exception("[Moodel] model not found '".$foreign[0]."', required in model '{$this->_name}'");}$foreign = array('table' => $model,'field' => @strtolower($foreign[1]));$this->_hasForeignKey = true;}}$args = explode('[', $type);if (sizeof($args) > 1) {$type = array_shift($args);$args = explode(',', substr(array_shift($args), 0, -1));}else {$args = array();}return array('type' => strtolower($type),'mods' => $mods,'args' => $args,'foreign' => $foreign);}public function prepareValue($fieldName, $value) {$type = $this->fieldType($fieldName);if ($type == null) {throw new Exception("[Moodel] Invalid field $fieldName");}if ($type['foreign']) {if (is_object($value)) {return $type['foreign']['table']->prepareValue($type['foreign']['field'], $value->get($type['foreign']['field']));}else {return $type['foreign']['table']->prepareValue($type['foreign']['field'], $value);}}switch ($type['type']) {case 'boolean' : case 'bool' :return $value === true ? 'TRUE' : 'FALSE';case 'int' : case 'integer' : case 'datetime' : case 'range' :return intval($value);case 'float' : case 'double' :return floatval($value);case 'serialize' : case 'serialized' : case 'serial' :return "'".$this->_db->escapeString(serialize($value))."'";}if ($value === null) {if (in_array('null', $type['mods'])) {return 'NULL';}return "''";}return "'".$this->_db->escapeString($value)."'";}public function primary() {return $this->_primary;}public function createTable($avoidTableExistsError=true, $debug=false) {$sql_fields = '';$sql_keys = '';foreach ($this->_fields as $name => $type) {$sql_fields .= "\n\t" . '`'.$name.'` ';switch ($type['type']) {case 'int' : case 'integer' :$sql_fields .= 'INT'; break;case 'text' :$sql_fields .= 'TEXT'; break;case 'longtext' :$sql_fields .= 'LONGTEXT'; break;case 'float' : case 'double' :$sql_fields .= 'FLOAT'; break;case 'string' :$sql_fields .= 'VARCHAR(255)'; break;case 'serialize' : case 'serialized' : case 'serial' :$sql_fields .= 'LONGTEXT'; break;case 'boolean' : case 'bool' :$sql_fields .= 'BOOL'; break;case 'datetime' :$sql_fields .= 'INT'; break;case 'range' :$sql_fields .= 'INT'; break;case 'char' : case 'chr' :$sql_fields .= 'VARCHAR('.$type['args'][0].')'; break;case 'enum' :$sql_fields .= 'ENUM(\''.implode("', '", $type['args']).'\')'; break;default :throw new Exception('[Moodel] Unsupported operation: field type '.$type['type']); break;}if (!in_array('null', $type['mods'])) {$sql_fields .= ' NOT NULL';}if (in_array('auto_increment', $type['mods'])) {$sql_fields .= ' AUTO_INCREMENT';}$sql_fields .= ',';if (in_array('primary_key', $type['mods'])) {$sql_keys .= "\n\t" . 'PRIMARY KEY (`'.$name.'`),';}if (in_array('unique', $type['mods'])) {$sql_keys .= "\n\t" . 'UNIQUE KEY `unique_'.$name.'` (`'.$name.'`),';}if (in_array('index', $type['mods'])) {$sql_keys .= "\n\t" . 'KEY `index_'.$name.'` (`'.$name.'`),';}if (in_array('fulltext', $type['mods'])) {$sql_keys .= "\n\t" . 'FULLTEXT KEY `fulltext_'.$name.'` (`'.$name.'`),';}}$sql = 'CREATE TABLE';if ($avoidTableExistsError) {$sql .= ' IF NOT EXISTS';}$sql .= ' `'.$this->_db->getDatabaseName().'`.`'.$this->_db->getPrefix().$this->_name.'` (';$sql .= substr($sql_fields, 0, -1);if ($sql_keys != '') {$sql .= ',' . substr($sql_keys, 0, -1);}$sql .= "\n" . ') ENGINE=MyISAM DEFAULT CHARSET=utf8 AUTO_INCREMENT=1;';if ($debug) {echo($sql);exit();}return $this->_db->query($sql);}public function fieldExists($name) {return isset($this->_fields[$name]);}public function fieldType($name) {return $this->fieldExists($name) ? $this->_fields[$name] : null;}public function fields() {return $this->_fields;}public function dbfields() {$tables = $this->_db->query('SHOW COLUMNS FROM `'.$this->_db->getDatabaseName().'`.`'.$this->_db->getPrefix().$this->_name.'`;');return $tables->all();}public function __get($name) {if ($name == 'new') {return $this->createNewModel();}if ($name == 'query') {$q = new QueryBuilder($this->_db, $this->name());$q->setModelBuilder(new MoodelBuilder($this));return $q;}return null;}public function setFactoryClass($className) {$this->_factoryClass = $className;}public function createNewModel() {$obj = new $this->_factoryClass();$obj->struct($this);return $obj;}public function name() {return $this->_name;}public function all($fields='*', $order=null) {$sql = 'SELECT * FROM `'.$this->_db->getDatabaseName().'`.`'.$this->_db->getPrefix().$this->_name.'`';if (is_string($order)) {$sql .= ' ORDER BY ' . $order;}if ($this->debug_out) {echo($sql);}$dbr = $this->_db->query($sql);if ($dbr instanceof MySQLResultSet) {return $this->createMoodels($dbr);}return array();}public function getById($id) {if ($this->primary() == null) {throw new Exception('[Moodel] Cannot perform operation getById : no primary key defined');}$sql = '
SELECT * FROM `'.$this->_db->getDatabaseName().'`.`'.$this->_db->getPrefix().$this->_name.'`
WHERE `'.$this->primary().'` = '.$this->prepareValue($this->primary(), $id).'
LIMIT 1;';if ($this->debug_out) {echo($sql);}$dbr = $this->_db->query($sql);if ($dbr instanceof MySQLResultSet) {if ($dbr->size() == 0) {return null;}$list = $this->createMoodels($dbr);return $list[0];}else return null;}public function select($where, $order=null, $limit=null) {return $this->get($where, array('*'), $order, $limit);}public function get($where, $queryFields=array('*'), $order=null, $limit=null) {if (!is_array($where)) {throw new Exception('[Moodel] Invalid Argument Exception : parameter #1 $where must be an array');}$sql = '';$i = 0;foreach ($where as $field => $value) {if (!$this->fieldExists($field)) {continue;}$type = $this->fieldType($field);if (substr($value, 0, 6) == 'match:') {if (!in_array('fulltext', $type['mods'])) {throw new Exception("[Moodel] Can't find FULLTEXT index for field '$field'");}$tmp = "MATCH (`$field`) AGAINST (".$this->prepareValue($field, substr($value, 6)).")";$sql .= ($i > 0 ? ' AND ' : '') . ' ' . $tmp;}else if (substr($value, 0, 9) == 'contains:') {$sql .= ($i > 0 ? ' AND ' : '') . " `$field` LIKE ".$this->prepareValue($field, '%' . substr($value, 9) . '%');}else if (substr($value, 0, 11) == 'beginswith:') {$sql .= ($i > 0 ? ' AND ' : '') . " `$field` LIKE ".$this->prepareValue($field, substr($value, 11) . '%');}else if (substr($value, 0, 9) == 'endswith:') {$sql .= ($i > 0 ? ' AND ' : '') . " `$field` LIKE ".$this->prepareValue($field, '%' . substr($value, 9));}else if (substr($value, 0, 2) == '>:') {$sql .= ($i > 0 ? ' AND ' : '') . " `$field` > ".$this->prepareValue($field, substr($value, 2));}else if (substr($value, 0, 2) == '<:') {$sql .= ($i > 0 ? ' AND ' : '') . " `$field` < ".$this->prepareValue($field, substr($value, 2));}else if (substr($value, 0, 4) == 'not:') {$sql .= ($i > 0 ? ' AND ' : '') . " `$field` != ".$this->prepareValue($field, substr($value, 4));}else {$sql .= ($i > 0 ? ' AND ' : '') . " `$field` = ".$this->prepareValue($field, $value);}$i++;}$sql = 'SELECT '.implode(', ', $queryFields).' FROM `'.$this->_db->getDatabaseName().'`.`'.$this->_db->getPrefix().$this->_name.'`' . (!empty($sql) ? ' WHERE' . $sql : '');if (is_string($order)) {$sql .= ' ORDER BY ' . $order;}if ($limit != null) {$sql .= ' LIMIT '.$limit;}$sql .= ';';if ($this->debug_out) {echo($sql);}return $this->createMoodels($this->_db->query($sql));}public function createMoodel($row) {$m = $this->createNewModel();if ($row instanceof DBResultRow) {$row = $row->all();}if ($this->_hasForeignKey) {foreach ($this->_fields as $name => $info) {if ($info['foreign']) {if (isset($row[$name])) {$table = $info['foreign']['table'];$item = $table->get(array($info['foreign']['field'] => $row[$name]));$row[$name] = @$item[0];}}}}$m->values($row);return $m;}public function createMoodels(MySQLResultSet $set) {$r = array();foreach ($set as $row) {$r[] = $this->createMoodel($row);}return $r;}public function deleteWhere($where, $limit=0) {if (!is_array($where)) {throw new Exception('[Moodel] Cannot perform operation deleteWhere : $where must be an array');}$sql = 'DELETE FROM `'.$this->_db->getDatabaseName().'`.`'.$this->_db->getPrefix().$this->_name.'` WHERE';$i = 0;foreach ($where as $field => $value) {if ($i++ > 0) {$sql .= ' AND ';}$sql .= ' `'.$this->_db->getPrefix().$this->_name.'`.`'.$this->_db->escapeString($field).'` = ';$sql .= $this->prepareValue($field, $value);}if ($limit > 0) {$sql .= ' LIMIT '.intval($limit);}$sql .= ';';if ($this->debug_out) {echo($sql);}return $this->_db->query($sql);}public function delete(Moodel $model) {if ($model->struct()->name() != $this->name()) {throw new Exception('[Moodel] Cannot perform operation delete : Invalid model structure ('.$this->name().') for model ('.$model->struct()->name().')');}if ($this->primary() == null) {throw new Exception('[Moodel] Cannot perform operation delete : no primary key defined');}$data = $model->data();$sql = 'DELETE FROM `'.$this->_db->getDatabaseName().'`.`'.$this->_db->getPrefix().$this->_name.'` WHERE `'.$this->_db->getPrefix().$this->_name.'`.`'.$this->_db->escapeString($this->primary()).'` = \''.$this->prepareValue($this->primary(), $data[$this->primary()]).'\'
				LIMIT 1;';if ($this->debug_out) {echo($sql);}$affected_rows = $this->_db->query($sql);if ($affected_rows == 1) {return true;}$model->trigger('delete');return false;}public function drop($throw=false) {return $this->deleteTable($throw);}public function deleteTable($throw=false) {$sql = 'DROP TABLE `'.$this->_db->getDatabaseName().'`.`'.$this->_db->getPrefix().$this->_name.'`;';try {if (!$this->_db->query($sql)) {throw new Exception('[Moodel] Table drop failed');}}catch (Exception $ex) {if ($throw) {throw $ex;}}return $this;}public function truncate($throw=false) {return $this->clearTable($throw);}public function clearTable($throw=false) {$sql = 'TRUNCATE TABLE `'.$this->_db->getDatabaseName().'`.`'.$this->_db->getPrefix().$this->_name.'`;';try {if (!$this->_db->query($sql)) {throw new Exception('[Moodel] Table drop failed');}}catch (Exception $ex) {if ($throw) {throw $ex;}}return $this;}public function save(Moodel $model) {if ($model->struct()->name() != $this->name()) {throw new Exception('[Moodel] Cannot perform operation save : Invalid model structure ('.$this->name().') for model ('.$model->struct()->name().')');}$data = $model->data();if ($this->primary() != null && array_key_exists($this->primary(), $data) && $data[$this->primary()] != null) {$sql = 'UPDATE `'.$this->_db->getDatabaseName().'`.`'.$this->_db->getPrefix().$this->_name.'` SET ';$i = 0;foreach ($data as $field => $value) {if ($field == $this->primary()) {continue;}if (!$this->fieldExists($field)) {continue;}if ($i != 0) {$sql .= ', ';}$i++;$sql .= '`'.$field.'` = ';$sql .= $this->prepareValue($field, $data[$field]);}$sql .= ' WHERE `'.$this->_db->getPrefix().$this->_name.'`.`'.$this->primary().'` = \''.$this->prepareValue($this->primary(), $data[$this->primary()]).'\'';$sql .= ' LIMIT 1;';$r = $this->_db->query($sql);if ($r != -1) {$model->trigger('update', 'modified_fields='.sizeof($data).',modified_rows='.$r);$model->trigger('save');}return ($r != -1);}else {$sql = 'INSERT INTO `'.$this->_db->getDatabaseName().'`.`'.$this->_db->getPrefix().$this->_name.'` (';$i = 0;foreach ($this->_fields as $name => $type) {if ($i != 0) {$sql .= ', ';}$i++;$sql .= '`'.$name.'`';}$sql .= ') VALUES (';$i = 0;foreach ($this->_fields as $name => $type) {if ($i != 0) {$sql .= ', ';}$i++;if (!array_key_exists($name, $data)) {$sql .= in_array('null', $type['mods']) ? 'NULL' : "''";continue;}$sql .= $this->prepareValue($name, $data[$name]);}$sql .= ');';if ($this->debug_out) {echo($sql);}$id = $this->_db->query($sql);if ($id == -1) {return false;}$model->trigger('insert', 'new_id='.$id);$model->trigger('save');$model->id = $id;return true;}}public function count() {$q = $this->_db->query('SELECT COUNT(*) FROM `'.$this->_db->getDatabaseName().'`.`'.$this->_db->getPrefix().$this->_name.'`');if ($q->size() !== 1) return -1;return $q->current()->field('COUNT(*)');}public function __call($method, $args) {$mname = strtolower($method);if (substr($mname, 0, 5) == 'getby' && sizeof($args) > 0) {$db = $this->_db;$mname = substr($mname, 5);$sql = 'SELECT * FROM `'.$db->getDatabaseName().'`.`'.$db->getPrefix().$this->_name.'` WHERE `'.$mname."` = '".$db->escapeString($args[0])."'";if (isset($args[1]) && is_int($args[1])) {$sql .= ' LIMIT '.$args[1].';';}$q = $db->query($sql);if ($q->size() < 1) {return null;}if (isset($args[1]) && $args[1] === 1) {return $this->createMoodel($q->current());}return $this->createMoodels($q);}return null;}public function __toString() {return 'MoodelStruct:'.$this->_name;}}}if (!class_exists('MoodelBuilder')) {class MoodelBuilder implements ModelBuilder {}}if (!class_exists('Moodel')) {class Moodel {protected $_struct;protected $_data = array();protected $_listeners = array();public function struct(MoodelStruct $struct=null) {if ($struct != null) {$this->_struct = $struct;return $this;}return $this->_struct;}public function id() {if ($this->_struct->primary() != null) {return $this->get($this->_struct->primary());}return null;}public function data() {return $this->_data;}public function __get($name) {return $this->get($name);}public function get($name) {return array_key_exists($name, $this->_data) ? $this->_data[$name] : null;}public function __set($name, $value) {return $this->set($name, $value);}public function set($name, $value) {return $this->value($name, $value);}public function save() {return $this->_struct->save($this);}public function bind($event, Closure $callback) {if (is_string($event)) {$this->trigger('bind', array($event, &$callback));$this->_listeners[] = array($event, &$callback);}return $this;}public function trigger($event, $data=null) {if (is_string($event)) {foreach ($this->_listeners as $l) {if ($l[0] == '*' || $l[0] == $event) {$l[1]($data, $event, $this);}}}return $this;}public function value($key, $value='vmù$^vsd!3ù6ve', $throw=false) {if ($value === 'vmù$^vsd!3ù6ve') {return array_key_exists($key, $this->_data) ? $this->_data[$key] : null;}if ($throw && !$this->_struct->fieldExists($key)) {throw new Exception('[Moodel] Invalid field "'.$key.'" in model '.$this->_struct->name());}$type = $this->_struct->fieldType($key);if ($type != null && $type['foreign'] == null) {switch ($type['type']) {case 'int' : case 'integer' :if (is_object($value)) {$value = intval($value->id());}else {$value = intval($value);}break;case 'float' : case 'double' :$value = floatval($value); break;case 'datetime' :$value = intval($value); break;case 'serialize' : case 'serialized' : case 'serial' :if (is_string($value)) {$value = unserialize($value);}break;case 'boolean' : case 'bool' :$value = $value ? true : false; break;}}$this->_data[$key] = $value;$this->trigger('new_value', array('field' => $key, 'value' => $value));return $this;}public function values($values=null, $correction=array(), $throw=false) {if (is_array($values)) {foreach ($values as $key => $value) {if (array_key_exists($key, $correction)) {$key = $correction[$key];}$this->value($key, $value, $throw);}return $this;}return $this->_data;}public function setValues($values, $correction=array(), $throw=false) {return $this->values($values, $correction, $throw);}public function getValues() {return $this->values();}public function dispose() {$this->_struct = null;$this->_data = null;$this->_listeners = null;}public function delete() {$r = $this->_struct->delete($this);$this->dispose();return $r;}public function del() {return $this->delete();}public function __toString() {$r = $this->_struct->name() . '[';if (sizeof($this->_data) == 0) {return $r . ']';}foreach ($this->_data as $name => $value) {$field = $this->_struct->fieldType($name);$r .= $name.'=('.gettype($value).')';if ($field != null && in_array('password', $field['mods'])) {$r .= str_repeat('*', min(strlen($value), 10));}else if ($value === null) $r .= 'null';else if ($value === true) $r .= 'true';else if ($value === false) $r .= 'false';else if ($value === '') $r .= 'empty-string';else $r .= $value;$r .= ', ';}$r = substr($r, 0, -2) . ']';return $r;}}} ?>